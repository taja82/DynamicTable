<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <script>
        function calculateDepth(jsonArray) {
            let maxDepth = 1; // 최소한의 깊이는 1로 초기화

            for (let i = 0; i < jsonArray.length; i++) {
                if (Array.isArray(jsonArray[i].child)) {
                    // 현재 요소가 배열인 경우 재귀 호출을 통해 깊이 계산
                    const depth = 1 + calculateDepth(jsonArray[i].child);
                    maxDepth = Math.max(maxDepth, depth);
                }
            }

            return maxDepth;
        }

        function calculateTotalElements(jsonArray) {
            let totalElements = 0;

            for (let i = 0; i < jsonArray.length; i++) {
                if (Array.isArray(jsonArray[i])) {
                    // 현재 요소가 배열인 경우 재귀 호출을 통해 요소 갯수 계산
                    totalElements += calculateTotalElements(jsonArray[i]);
                } else {
                    // 현재 요소가 배열이 아닌 경우 (단일 값인 경우)
                    totalElements++;
                }
            }

            return totalElements;
        }

        //다시 작성(배열로 return 해야함)
        // function iterateArray(jsonArray) {
        //     for (let i = 0; i < jsonArray.length; i++) {
        //         if (Array.isArray(jsonArray[i])) {
        //             // 현재 요소가 배열인 경우 재귀 호출을 통해 순회
        //             iterateArray(jsonArray[i]);
        //         } else {
        //             // 현재 요소가 배열이 아닌 경우 (단일 값인 경우)
        //             console.log('배열의 값:', jsonArray[i]);
        //         }
        //     }
        // }

        function iterateArray(jsonArray) {
            const result = [];

            for (const item of jsonArray) {
                if (Array.isArray(item.child)) {
                    const childArr = iterateArray(item.child);
                    result.push(...childArr);
                } else {
                    result.push(item);
                }
            }

            return result;
        }

        function getElementsAtDepth(jsonArray, targetDepth, currentDepth = 0) {
            // 결과를 저장할 배열
            const result = [];

            for (const item of jsonArray) {
                if (currentDepth === targetDepth) {
                    // 현재 깊이가 목표 깊이와 일치하면 요소를 결과 배열에 추가
                    result.push(item);
                } else if (Array.isArray(item.child)) {
                    // 현재 요소가 배열이면 재귀적으로 깊이 우선 탐색 수행
                    const deeperElements = getElementsAtDepth(item.child, targetDepth, currentDepth + 1);
                    result.push(...deeperElements);
                }
                // 기타 경우에는 무시하고 계속 진행
            }

            return result;
        }

        function calculateColspan(childArray) {
            let colspan = 0;

            for (const childColumn of childArray) {
                colspan++;

                if (childColumn.child && childColumn.child.length > 0) {
                    // 하위 항목이 있는 경우 재귀적으로 호출하여 colspan 계산
                    colspan += calculateColspan(childColumn.child) - 1;
                }
            }

            return colspan;
        }

        //변수 명칭 같은거 좀 정리 해야함.
        function make(json) {

            let column = json.column;
            let result = "<table>\n"
            result += "<thead>\n";
            //console.log(calculateDepth(column));

            let depth = calculateDepth(column);
            for (let i = 0; i < depth; i++) {
                let json = column[i];
                result += "<tr>\n";
                let curdepth = getElementsAtDepth(column, i);
                for (let j = 0; j < curdepth.length; j++) {
                    result += "<th"

                    //console.log(curdepth[j]);
                    //rowspan (depth)

                    let rowspan = 1;
                    let colspan = 1;
                    if (curdepth[j].child) {
                        // console.log(json);
                        // console.log(calculateDepth(curdepth[j].child));
                        // console.log(calculateDepth(curdepth[j].child));
                        // console.log(curdepth[j]);

                        //console.log(getElementsAtDepth(curdepth[j].child, calculateDepth(curdepth[j].child)-1).length);


                        //console.log(curdepth[j].child);
                        //colspan = calculateDepth(curdepth[j].child) + 1;
                        //colspan = getElementsAtDepth(curdepth[j].child, calculateDepth(curdepth[j].child) - 1).length;
                        //console.log(curdepth[j].name, "colspan : " + calculateColspan(curdepth[j].child));
                        colspan = calculateColspan(curdepth[j].child);

                    } else {
                        //child가 없는 경우에는 전체 tr 갯수에서 i 뺀 갯수
                        //rowspan = depth;
                        rowspan = depth - i;
                    }

                    //console.log("\n");
                    if (rowspan > 1) {
                        result += " rowspan=" + "'" + rowspan + "'";
                    }

                    if (colspan > 1) {
                        result += " colspan=" + "'" + colspan + "'";
                    }

                    if (curdepth[j].width) {
                        result += " width=" + "'" + curdepth[j].width + "'";
                    }

                    result += ">";
                    result += curdepth[j].name;
                    result += "</th>\n";
                }
                result += "</tr>\n";
            }
            result += "</thead>\n";

            let body = json.data;

            if (body) {
                result += "<tbody>\n";
                for (let i = 0; i < body.length; i++) {
                    result += "<tr>\n";

                    let it = iterateArray(column);

                    if (Array.isArray(body[i])) {
                        //항목이 array인 경우

                        //header와 body의 갯수가 맞지 않는 경우
                        //header가 더 많다면 body에 차이만큼 빈 td값 채워넣고
                        //body가 더 많다면 나머지 값은 무시

                        let content = body[i];

                        for (let j = 0; j < content.length; j++) {
                            //header보다 body값이 더 많다먼 나머지 값 무시
                            if (j > it.length - 1) {
                                break;
                            }

                            result += "<td>";
                            result += content[j];
                            result += "</td>\n";
                        }

                        //header가 body보다 더 많다면
                        //빈 td값 채워넣기
                        if(it.length > content.length) {
                            for(let j = 0; j < it.length - content.length; j++) {
                                result += "<td>";
                                result += "</td>\n";
                            }
                        }

                        //for 반복을 header 기준으로 작성(이러면 반복문 한개에 끝낼 수 있을거 같음..)
                        //for (let j = 0; j <)
                    } else if (typeof body[i] === "object") {
                        //항목이 json인 경우

                        //헤더에 있고 body에 해당 key가 없으면, 중간에 나사가 빠지는 느낌임.
                        //비교해보고 없는 항목이라면 중간에 빈 td값을 채워넣어야 함.

                        //console.log(iterateArray(column));
                        let content = getElementsAtDepth(column, 0);
                        // for(let j = 0; j < content.length; j++) {

                        // }

                        let it = iterateArray(column);
                        //console.log(it);
                        let keyarray = Object.keys(body[i]);
                        for (let j = 0; j <= keyarray.length; j++) {
                            //console.log(Object.keys(body[i]));

                            //header보다 body가 더 많으면 에러나기에 작성(맞게 한건가 모르겟음..)
                            if (j > it.length - 1) {
                                break;
                            }

                            console.log(body[i][it[j].name]);

                            //body에 선언된 key가 header에 없으면 안 들어가게 하려고 함.
                            // if (!keyarray.includes(it[j].name)) {
                            //     console.log("excluded", it[j].name);
                            //     continue;
                            // } else
                            if(body[i][it[j].name] == undefined) {
                                console.log(true);
                                //헤더의 이름을 json키에 대입하고 null인 경우 빈 td값
                                result += "<td>";
                                result += "</td>\n";
                            } else {
                                //반대로 header에 선언된 key가 body에 없다면 body 해당 부분에 빈 td 추가
                                //console.log(body[i]);
                                //console.log(it[j].name);
                                result += "<td>";
                                result += body[i][it[j].name];
                                result += "</td>\n";
                            }
                        }

                        if(it.length - 1 > keyarray.length) {
                            for(let j = 0; j < it.length - keyarray.length; j++) {
                                result += "<td>";
                                result += "</td>\n";
                            }
                        }
                    }

                    result += "</tr>\n";
                }
                result += "</tbody>\n";
            }

            result += "</table>"

            return result;
        }


        let json = {
            column: [
                {
                    name: "1",
                    width: 60
                },
                {
                    name: "2",
                    width: 120
                },
                {
                    name: "3",
                    width: 120,
                    child: [
                        {
                            name: "3-1"
                        },
                        {
                            name: "3-2"
                        }
                    ]
                },
                {
                    name: "4",
                    width: 120,
                    child: [
                        {
                            name: "4-1"
                        },
                        {
                            name: "4-2"
                        },
                        {
                            name: "4-3"
                        }
                    ]
                },
                {
                    name: "5",
                    width: 120,
                    child: [
                        {
                            name: "5-1",
                            child: [
                                {
                                    name: "5-1-1"
                                },
                                {
                                    name: "5-1-2"
                                },
                                {
                                    name: "5-1-3"
                                },
                                {
                                    name: "5-1-4",
                                    child: [
                                        {
                                            name: "5-1-4-1",
                                            child: [
                                                {
                                                    name: "5-1-4-1-1"
                                                }
                                            ]
                                        },
                                        {
                                            name: "5-1-4-2"
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "5-2",
                            child: [
                                {
                                    name: "5-2-1"
                                },
                                {
                                    name: "5-2-2"
                                }
                            ]
                        }
                    ]
                }
            ],
            data: [
                {
                    "1": "1번째",
                    "2": "2번째",
                    "8": "8번째",
                    "3-1": "3-1번째",
                    "3-2": "3-2번째",
                    "4-1": "4-1번째",
                    "4-2": "4-2번째",
                    "5-1-1": "5-1-1번째",
                    "5-1-2": "5-1-2번째",
                    "6-1": "6-1번째",
                    "7-1": "7-1번째",
                    "5-2": "5-2번째",
                    "5-1-4-1": "5-1-4-1번째",
                    "5-2-2": "5-2-2번째"
                },
                ["1", "2", "3-1", "3-2", "4-1", "4-2", "5-1-1", "5-1-2", "5-2", "6", "7"]
            ]
        }

        document.write(make(json));
    </script>
</body>

</html>