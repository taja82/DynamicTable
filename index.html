<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <script>
        function calculateDepth(jsonArray) {
            let maxDepth = 1; // 최소한의 깊이는 1로 초기화

            for (let i = 0; i < jsonArray.length; i++) {
                if (Array.isArray(jsonArray[i].child)) {
                    // 현재 요소가 배열인 경우 재귀 호출을 통해 깊이 계산
                    const depth = 1 + calculateDepth(jsonArray[i].child);
                    maxDepth = Math.max(maxDepth, depth);
                }
            }

            return maxDepth;
        }

        function calculateTotalElements(jsonArray) {
            let totalElements = 0;

            for (let i = 0; i < jsonArray.length; i++) {
                if (Array.isArray(jsonArray[i])) {
                    // 현재 요소가 배열인 경우 재귀 호출을 통해 요소 갯수 계산
                    totalElements += calculateTotalElements(jsonArray[i]);
                } else {
                    // 현재 요소가 배열이 아닌 경우 (단일 값인 경우)
                    totalElements++;
                }
            }

            return totalElements;
        }

        //다시 작성(배열로 return 해야함)
        // function iterateArray(jsonArray) {
        //     for (let i = 0; i < jsonArray.length; i++) {
        //         if (Array.isArray(jsonArray[i])) {
        //             // 현재 요소가 배열인 경우 재귀 호출을 통해 순회
        //             iterateArray(jsonArray[i]);
        //         } else {
        //             // 현재 요소가 배열이 아닌 경우 (단일 값인 경우)
        //             console.log('배열의 값:', jsonArray[i]);
        //         }
        //     }
        // }

        function iterateArray(jsonArray) {
            const result = [];

            for (const item of jsonArray) {
                if (Array.isArray(item.child)) {
                    const childArr = iterateArray(item.child);
                    result.push(...childArr);
                } else {
                    result.push(item);
                }
            }

            return result;
        }

        function getElementsAtDepth(jsonArray, targetDepth, currentDepth = 0) {
            // 결과를 저장할 배열
            const result = [];

            for (const item of jsonArray) {
                if (currentDepth === targetDepth) {
                    // 현재 깊이가 목표 깊이와 일치하면 요소를 결과 배열에 추가
                    result.push(item);
                } else if (Array.isArray(item.child)) {
                    // 현재 요소가 배열이면 재귀적으로 깊이 우선 탐색 수행
                    const deeperElements = getElementsAtDepth(item.child, targetDepth, currentDepth + 1);
                    result.push(...deeperElements);
                }
                // 기타 경우에는 무시하고 계속 진행
            }

            return result;
        }

        function calculateColspan(childArray) {
            let colspan = 0;

            for (const childColumn of childArray) {
                colspan++;

                if (childColumn.child && childColumn.child.length > 0) {
                    // 하위 항목이 있는 경우 재귀적으로 호출하여 colspan 계산
                    colspan += calculateColspan(childColumn.child) - 1;
                }
            }

            return colspan;
        }

        //변수 명칭 같은거 좀 정리 해야함.
        function make(json) {

            let column = json.column;

            let table = document.createElement("table");
            let thead = document.createElement("thead");
            table.appendChild(thead);

            // let result = "<table>\n"
            // result += "<thead>\n";
            //console.log(calculateDepth(column));

            //body에도 colspan, rowspan 입력 가능하도록 하려고 하는데.. 이것도 만만치 않다.
            //colspan의 경우 tr마다 해당 열의 모든 컬럼의 colspan의 합계를 구해서 어디까지 td를 생성할 것인지 판단해야 함.
            //rowspan의 경우 최대 tr의 갯수까지 늘릴 수 있고, 더 넘어가면 최대 tr의 갯수 고정
            let depth = calculateDepth(column);
            for (let i = 0; i < depth; i++) {
                let json = column[i];
                let tr = document.createElement("tr");

                //result += "<tr>\n";
                let curdepth = getElementsAtDepth(column, i);
                for (let j = 0; j < curdepth.length; j++) {
                    let th = document.createElement("th");
                    //result += "<th"

                    //console.log(curdepth[j]);
                    //rowspan (depth)

                    let rowspan = 1;
                    let colspan = 1;
                    if (curdepth[j].child) {
                        // console.log(json);
                        // console.log(calculateDepth(curdepth[j].child));
                        // console.log(calculateDepth(curdepth[j].child));
                        // console.log(curdepth[j]);

                        //console.log(getElementsAtDepth(curdepth[j].child, calculateDepth(curdepth[j].child)-1).length);


                        //console.log(curdepth[j].child);
                        //colspan = calculateDepth(curdepth[j].child) + 1;
                        //colspan = getElementsAtDepth(curdepth[j].child, calculateDepth(curdepth[j].child) - 1).length;
                        //console.log(curdepth[j].name, "colspan : " + calculateColspan(curdepth[j].child));
                        colspan = calculateColspan(curdepth[j].child);

                    } else {
                        //child가 없는 경우에는 전체 tr 갯수에서 i 뺀 갯수
                        //rowspan = depth;
                        rowspan = depth - i;
                    }

                    //console.log("\n");
                    if (rowspan > 1) {
                        //result += " rowspan=" + "'" + rowspan + "'";
                        th.rowSpan = rowspan;
                    }

                    if (colspan > 1) {
                        //result += " colspan=" + "'" + colspan + "'";
                        th.colSpan = colspan;
                    }

                    //나중에 css라던가, align, width 같은거는 option으로 하나 만들려고 함
                    if (curdepth[j].width) {
                        //result += " width=" + "'" + curdepth[j].width + "'";
                        //th.width = curdepth[j].width;
                        th.style.width = curdepth[j].width + "px";
                    }

                    //result += ">";
                    //result += curdepth[j].name;
                    th.appendChild(document.createTextNode(curdepth[j].name));
                    //result += "</th>\n";
                    tr.appendChild(th);
                }
                //result += "</tr>\n";
                thead.appendChild(tr);
            }
            //result += "</thead>\n";
            table.appendChild(thead);

            let body = json.data;

            if (body) {
                let tbody = document.createElement("tbody");
                //result += "<tbody>\n";
                for (let i = 0; i < body.length; i++) {
                    let tr = document.createElement("tr");
                    //result += "<tr>\n";

                    let it = iterateArray(column);

                    if (Array.isArray(body[i])) {
                        //항목이 array인 경우

                        let content = body[i];
                        for (let j = 0; j < it.length; j++) {
                            let td = document.createElement("td");
                            
                            //result += "<td>";
                            //result += content[j] ? content[j] : "";
                            //result += "</td>\n";

                            td.appendChild(document.createTextNode(content[j] ? content[j] : ""));

                            tr.appendChild(td);
                        }
                    } else if (typeof body[i] === "object") {
                        //항목이 json인 경우

                        let it = iterateArray(column);
                        //console.log(it);
                        let keyarray = Object.keys(body[i]);
                        for (let j = 0; j <= keyarray.length; j++) {
                            //console.log(Object.keys(body[i]));

                            //header보다 body가 더 많으면 에러나기에 작성(맞게 한건가 모르겟음..)
                            if (j > it.length - 1) {
                                break;
                            }

                            //console.log(body[i][it[j].name]);

                            //body에 선언된 key가 header에 없으면 안 들어가게 하려고 함.
                            // if (!keyarray.includes(it[j].name)) {
                            //     console.log("excluded", it[j].name);
                            //     continue;
                            // } else

                            let td = document.createElement("td");
                            
                            if(body[i][it[j].name] != undefined) {
                                //반대로 header에 선언된 key가 body에 없다면 body 해당 부분에 빈 td 추가
                                //console.log(body[i]);
                                //console.log(it[j].name);

                                //result += "<td>";
                                //result += body[i][it[j].name];
                                //result += "</td>\n";

                                td.appendChild(document.createTextNode(body[i][it[j].name]));
                            }

                            tr.appendChild(td);
                        }

                        if(it.length - 1 > keyarray.length) {
                            let td = document.createElement("td");

                            for(let j = 0; j < it.length - keyarray.length; j++) {
                                //result += "<td>";
                                //result += "</td>\n";

                            }

                            tr.appendChild(td);
                        }
                    }

                    //result += "</tr>\n";
                    tbody.appendChild(tr);
                }
                //result += "</tbody>\n";
                table.appendChild(tbody);
            }

            //result += "</table>"

            return table;
        }


        let json = {
            column: [
                {
                    name: "1",
                    width: 60
                },
                {
                    name: "2",
                    width: 120
                },
                {
                    name: "3",
                    width: 120,
                    child: [
                        {
                            name: "3-1"
                        },
                        {
                            name: "3-2"
                        }
                    ]
                },
                {
                    name: "4",
                    width: 120,
                    child: [
                        {
                            name: "4-1"
                        },
                        {
                            name: "4-2"
                        },
                        {
                            name: "4-3"
                        }
                    ]
                },
                {
                    name: "5",
                    width: 120,
                    child: [
                        {
                            name: "5-1",
                            child: [
                                {
                                    name: "5-1-1"
                                },
                                {
                                    name: "5-1-2"
                                },
                                {
                                    name: "5-1-3"
                                },
                                {
                                    name: "5-1-4",
                                    child: [
                                        {
                                            name: "5-1-4-1",
                                            child: [
                                                {
                                                    name: "5-1-4-1-1"
                                                }
                                            ]
                                        },
                                        {
                                            name: "5-1-4-2"
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "5-2",
                            child: [
                                {
                                    name: "5-2-1",
                                    width: 100
                                },
                                {
                                    name: "5-2-2"
                                }
                            ]
                        },
                    ]
                },
                {
                    name: "6",
                    width: 70
                }
            ],
            data: [
                {
                    "1": "1번째",
                    "2": "2번째",
                    "8": "8번째",
                    "3-1": "3-1번째",
                    "3-2": "3-2번째",
                    "4-1": "4-1번째",
                    "4-2": "4-2번째",
                    "5-1-1": "5-1-1번째",
                    "5-1-2": "5-1-2번째",
                    "6-1": "6-1번째",
                    "7-1": "7-1번째",
                    "5-2": "5-2번째",
                    "5-1-4-1": "5-1-4-1번째",
                    "5-2-2": "5-2-2번째"
                },
                ["1", "2", "3-1", "3-2", "4-1", "4-2", "5-1-1", "5-1-2", "5-2", "6", "7", "8", "9", "10", "11", "12"]
            ]
        }

        //document.write(make(json));
        let result = make(json);

        //html 필요하면 이렇게 사용할것.
        console.log(result.outerHTML);
        document.body.appendChild(result);
    </script>
</body>

</html>